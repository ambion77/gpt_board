<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPTìƒì„± ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="board.css">
</head>
<body>
    <div class="board-container">
        <h1>GPT ìƒì„± ê²Œì‹œíŒ</h1>
        <div class="board-buttons">
            <button onclick="openCreatePopup()" style="margin-top: 10px;">ìƒˆê¸€</button>
            <button onclick="deleteSelectedPosts()" style="margin-top: 10px;">ì‚­ì œ</button>
        </div>
        <table id="postTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>ë²ˆí˜¸</th>
                    <th>ì œëª©</th>
                    <th>ì‘ì„±ì</th>
                    <th>ì¡°íšŒìˆ˜</th>
                    <th>ì‘ì„±ì¼</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="pagination" class="pageArea"></div>
    </div>

    <!-- íŒì—… ë ˆì´ì–´ -->
    <div id="popupLayer" class="popup-layer">
        <div class="popup-content">
            <span class="close-btn" onclick="closePopup()">âœ–</span>
            <h2 id="popupTitle"></h2>
            <p id="popupContent"></p>
            <p id="popupAuthor"></p>
            <p id="popupDate"></p>
        </div>
    </div>

    <script>
        // ğŸ“Œ ì²´í¬ë°•ìŠ¤ ì „ì²´ ì„ íƒ/í•´ì œ
        document.getElementById("selectAll").addEventListener("change", function() {
            const checkboxes = document.querySelectorAll(".post-checkbox");
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        // ğŸ“Œ ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadPosts(page = 1) {
            fetch(`/posts?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector("#postTable tbody");
                    tbody.innerHTML = "";

                    data.posts.forEach((post) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td><input type="checkbox" class="post-checkbox" value="${post.id}"></td>
                            <td>${post.id}</td>
                            <td>
                                <a href="#" class="post-title" 
                                    data-id="${post.id}" 
                                    style="--depth: ${post.depth || 0}">
                                    ${post.title}
                                </a>
                            </td>
                            <td>${post.author}</td>
                            <td>${post.views}</td>
                            <td>${post.date}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    updatePagination(data.currentPage, data.totalPages);

                    // ğŸ“Œ ì œëª© í´ë¦­ ì‹œ íŒì—… ë ˆì´ì–´ í‘œì‹œ
                    document.querySelectorAll(".post-title").forEach(title => {
                        title.addEventListener("click", function(event) {
                            event.preventDefault();
                            const postId = this.getAttribute("data-id");
                            openPopup(postId);
                        });
                    });
                });
        }

        // ìƒì„¸ íŒì—…
        function openPopup(postId) {
            fetch(`/post/${postId}`)
                .then(response => response.json())
                .then(post => {
                    const popupLayer = document.getElementById("popupLayer");
                    const popupContent = document.querySelector(".popup-content");

                    if (!popupLayer || !popupContent) {
                        console.error("âŒ íŒì—… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    popupContent.innerHTML = `
                        <span class="close-btn" onclick="closePopup()">âœ–</span>
                        <h2><input type='text' id='editTitle' value='${post.title}'></h2>
                        <p><textarea class='editTxtArea' id='editContent'>${post.content}</textarea></p>
                        <p id="popupAuthor">ì‘ì„±ì: ${post.author}</p>
                        <p id="popupDate">ì‘ì„±ì¼: ${post.date}</p>
                        <input id="popupViews" type="hidden" value='${post.views}'></input>
                        <input id="popupDepth" type="hidden" value='${post.depth}'></input>
                        <div class="popup-buttons" style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button id="replyPostButton" class="reply-btn">ë‹µê¸€</button>
                            <button id="updatePostButton" class="update-btn">ìˆ˜ì •</button>
                            <button id="deletePostButton" class="delete-btn">ì‚­ì œ</button>
                        </div>
                    `;

                    
                    document.getElementById("replyPostButton").onclick = () => openReplyPopup(post.id);
                    document.getElementById("updatePostButton").onclick = () => updatePost(post.id);
                    document.getElementById("deletePostButton").onclick = () => deletePost(post.id);

                    popupLayer.style.display = "flex";
                })
                .catch(error => console.error("âŒ ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
        }

        // ğŸ“Œ íŒì—… ë‹«ê¸°
        function closePopup() {
            document.getElementById("popupLayer").style.display = "none";
            setTimeout(() => {
                window.location.reload(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            }, 100);  // 100ms í›„ ìƒˆë¡œê³ ì¹¨ (ì´ë™ í›„ ë°˜ì˜)
        }

        // ğŸ“Œ í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        function updatePagination(currentPage, totalPages) {
            const paginationContainer = document.getElementById("pagination");
            paginationContainer.innerHTML = "";

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement("button");
                button.innerText = i;
                button.onclick = () => loadPosts(i);
                if (i === currentPage) {
                    button.style.fontWeight = "bold";
                }
                paginationContainer.appendChild(button);
            }
        }

        // ğŸ“Œ ëª©ë¡ì—ì„œ ì²´í¬ëœ í•­ëª© ì‚­ì œ
        function deleteSelectedPosts() {
            const checkedBoxes = document.querySelectorAll(".post-checkbox:checked");
            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                alert("â— ì‚­ì œí•  ê²Œì‹œê¸€ì„ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            fetch("/deletePosts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ids: selectedIds })
            }).then(response => response.json())
            .then(data => {
                alert(data.message);
                loadPosts(); // ì‚­ì œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            });
        }

        //ìƒì„¸ ìˆ˜ì •
        function updatePost(postId) {
            const updatedPost = {
                id: postId,
                title: document.getElementById("editTitle").value,
                author: document.getElementById("popupAuthor").innerText.replace("ì‘ì„±ì: ", ""),
                content: document.getElementById("editContent").value,
                date: document.getElementById("popupDate").innerText.replace("ì‘ì„±ì¼: ", ""),
                depth: document.getElementById("popupDepth").value,
                views: document.getElementById("popupViews").value
            };

            fetch("/updatePosts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedPost)
            }).then(response => response.json())
            .then(data => {
                alert(data.message);
                closePopup();
                loadPosts();
            });
        }

        //ìƒì„¸íŒì—…ì—ì„œ ì‚­ì œ
        function deletePost(postId) {
            if (!confirm("ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            fetch(`/deletePost/${postId}`, {
                method: "DELETE"
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                closePopup();
                loadPosts(); // ê²Œì‹œê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            })
            .catch(error => console.error("âŒ ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
        }

        // ğŸ“Œ ìƒˆ ê¸€ ì‘ì„± íŒì—…
        function openCreatePopup() {
            const popupLayer = document.getElementById("popupLayer");
            const popupContent = document.querySelector(".popup-content");
            popupContent.innerHTML = `
                <span class="close-btn" onclick="closePopup()">âœ–</span>
                <h2>ìƒˆ ê¸€ ì‘ì„±</h2>
                <input type='text' id='newTitle' placeholder='ì œëª© ì…ë ¥' maxlength='100'>
                <textarea class='addTxtArea' id='newContent' placeholder='ë‚´ìš© ì…ë ¥' maxlength='1000'></textarea>
                <p id="popupAuthor">ì‘ì„±ì: <input type='text' id='newAuthor' maxlength='20'></p>
                <div class="popup-buttons">
                    <button id="createPostButton" class="create-btn">ë“±ë¡</button>
                </div>
            `;
            document.getElementById("createPostButton").onclick = createPost;
            popupLayer.style.display = "flex";
        }

        // ğŸ“Œ ìƒˆ ê¸€ ì‘ì„±
        function createPost() {
            const title = document.getElementById("newTitle").value.trim();
            const author = document.getElementById("newAuthor").value.trim();
            const content = document.getElementById("newContent").value.trim();

            if (!title || !author || !content) {
                alert("âš ï¸ ì œëª©, ì‘ì„±ì, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (title.length > 50) {
                alert("âš ï¸ ì œëª©ì€ 50ê¸€ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            if (author.length > 10) {
                alert("âš ï¸ ì‘ì„±ìëŠ” 10ê¸€ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            if (content.length > 1000) {
                alert("âš ï¸ ë‚´ìš©ì€ 1000ê¸€ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const newPost = { title, author, content };

            fetch("/createPosts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newPost)
            }).then(response => response.json())
            .then(data => {
                alert(data.message);
                closePopup();
                loadPosts();
            });
        }

        // ë‹µë³€ê¸€ íŒì—… 
        function openReplyPopup(postId) {
            const popupLayer = document.getElementById("popupLayer");
            const popupContent = document.querySelector(".popup-content");
            popupContent.innerHTML = `
                <span class="close-btn" onclick="closePopup()">âœ–</span>
                <h2>ë‹µë³€ ì‘ì„±</h2>
                <textarea class='editTxtArea' id='replyContent' placeholder='ë‹µë³€ ì…ë ¥' maxlength='1000'></textarea>
                <p>ì‘ì„±ì: <input type='text' id='replyAuthor' maxlength='10'></p>
                <div class="popup-buttons">
                    <button id="submitReplyButton" class="create-btn">ë“±ë¡</button>
                </div>
            `;
            document.getElementById("submitReplyButton").onclick = () => submitReply(postId);
            popupLayer.style.display = "flex";
        }

        //ë‹µë³€ê¸€ ì“°ê¸°
        function submitReply(postId) {
            const author = document.getElementById("replyAuthor").value.trim();
            const content = document.getElementById("replyContent").value.trim();

            if (!author || !content) {
                alert("âš ï¸ ì‘ì„±ìì™€ ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (author.length > 10) {
                alert("âš ï¸ ì‘ì„±ìëŠ” 10ê¸€ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            if (content.length > 1000) {
                alert("âš ï¸ ë‹µë³€ ë‚´ìš©ì€ 1000ê¸€ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const reply = { postId, author, content };
            
            fetch("/addReply", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(reply)
            }).then(response => response.json())
            .then(data => {
                alert(data.message);
                closePopup();
                loadPosts();
            });
        }


        // ğŸ“Œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadPosts();
    </script>
</body>
</html>
